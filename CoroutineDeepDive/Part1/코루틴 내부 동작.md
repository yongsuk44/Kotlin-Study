# Coroutines 내부 동작

아래는 코루틴이 어떻게 동작하는지에 대한 핵심 내용들입니다.

### suspend 함수는 상태 기계와 유사

suspend 함수는 호출이 일시 중단될 수 있고 나중에 다시 재개될 수 있는 함수입니다.
이러한 함수는 상태 기계와 유사하게 작동하는데, 각 일시 중단 호출 후에 특정 상태를 가지게 됩니다.

함수가 일시 중단되면 특정 지점에서 실행을 멈추고, 재개될 때는 멈춘 지점부터 계속 진행합니다.
이것은 복잡한 비동기 로직을 동기식 코드처럼 보이게 만들어 유지보수와 코드 가독성에 이점을 지닙니다.

> **상태 기계(State Machines)**  
> 특정 시스템이 가질 수 있는 "여러 상태"와 그 상태 사이의 전환되는 규칙을 정의하는 수학적 모델,  
> 상태 기계는 현재 상태와 일련의 전환이나 이벤트에 의해 다른 상태로 이동할 수 있는 규칙을 가지고 있음  

> 코루틴 내의 suspend 함수는 여러 상태를 가질 수 있으며, 일시 중단되는 시점마다 다른 상태로 전환됨  
> 코루틴 내부에 3개의 일시 중단 지점이 있다면, 4개의 상태를 가질 수 있음(시작 상태, 1번째, 2번째, 3번째 일시 중단 후)

### 상태 번호와 로컬 데이터는 continuation 객체에 저장됨

코루틴의 `Continuation`객체는 코루틴의 현재 상태를 추적합니다.

상태 번호는 현재 실행 중인 단계를 나타내고, 로컬 데이터는 변수와 같은 중간 계산 값을 포함할 수 있습니다.

코루틴이 일시 중단되면, 이 `continuation` 객체는 나중에 코루틴을 정확한 지점에서 재개할 수 있는 모든 정보를 유지 합니다

### 쌓이는 함수 호출로 인한 continuation 객체 체인 생성

코루틴은 함수의 호출과 재개를 다룰 때 연속성을 유지하기 위해 `continuation` 객체를 사용합니다.  
하나의 함수가 다른 함수를 호출할 때, 호출된 함수의 `continuation`은 호출하는 함수의 continuation을 decoration하게 됩니다.

이로 인해 연결된 `continuation` 객체의 체인이 생성되며, 이 체인은 전체 호출 스택을 나타내게 됩니다.  
코루틴이 재개되거나 완료될 때, 이 체인은 현재 실행 상태를 제어하고 정확한 지점에서 실행을 계속 하게 됩니다.

---

## Continuation-passing style

suspend 함수를 구현하는 몇 가지 방법 중, Kotlin 팀은 continuation-passing style을 선택했습니다.

Continuation-passing style은 `contiunuation`이 인수로 함수에서 함수로 전달되는 것을 의미하며
일반적으로 `continuation`은 아래와 예제와 같이 마지막 파라미터 위치에 놓이게 됩니다.

```kotlin
suspend fun getUser(): User?
suspend fun setUser(user: User)
suspend fun checkAvailability(flight: Flight): Boolean

// under the hood is
fun getUser(continuation: Continuation<*>): Any?
fun setUser(user: User, continuation: Continuation<*>): Any
fun checkAvailability(flight: Flight, continuation: Continuation<*>): Any
```

위 코드를 보면 내부적으로 변경되었을 때 원래 선언된 것과 달리 `Any` 또는 `Any?`로 반환 타입을 갖는것을 볼 수 있습니다.

이는 suspend 함수가 일시 중단될 수 있어 선언된 타입을 반환하지 않을 가능성이 있기 때문입니다.  
이러한 경우 `COROUTINE_SUSPENDED` 마커를 반환하게 됩니다.

즉 `getUser`가 `User?` 또는 `COROUTINE_SUSPENDED`(`Any` 타입)을 반환할 수 있어,   
결과 타입은 `User? | Any`의 가장 근접한 상위 타입인 `Any?`이어야 합니다.

만약 언젠가 Kotlin이 union 타입을 도입하게 되면 `User? | COROUTINE_SUSPENDED` 형태로 변경될 것 입니다.